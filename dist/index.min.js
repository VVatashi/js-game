(()=>{var lt=Object.defineProperty;var ct=(o,e,t)=>e in o?lt(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var J=(o,e,t)=>ct(o,typeof e!="symbol"?e+"":e,t);var ce=class{constructor(){let e=new AudioContext,t=e.createGain();t.connect(e.destination),t.gain.value=.2,this.context=e,this.gainNode=t}resume(){let{context:e}=this;return e.resume(),this}suspend(){let{context:e}=this;return e.suspend(),this}play(e,t=!1){let{context:n,gainNode:r}=this,i=n.createBufferSource();return i.buffer=e,i.loop=t,i.connect(r),i.start(),this}};var he=class{constructor(e,t,n){let r=e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,r),e.renderbufferStorageMultisample(e.RENDERBUFFER,e.getParameter(e.MAX_SAMPLES),e.RGBA8,t,n),this.context=e,this.handle=r,this.width=t,this.height=n}bind(){let{context:e,handle:t}=this;return e.bindRenderbuffer(e.RENDERBUFFER,t),this}delete(){let{context:e,handle:t}=this;t!==null&&(e.deleteRenderbuffer(t),this.handle=null)}},V=class{constructor(e,t,n){let r=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,r),e.viewport(0,0,t,n),e.bindFramebuffer(e.FRAMEBUFFER,null),this.context=e,this.handle=r,this.width=t,this.height=n}attachTexture(e){let{context:t,attachment:n}=this;return this.bind(),e.bind(),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e.handle,0),this.attachment=e,this.unbind(),n?.delete(),this}attachRenderbuffer(e){let{context:t,attachment:n}=this;return this.bind(),e.bind(),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,e.handle),this.attachment=e,this.unbind(),n?.delete(),this}resize(e,t){let{context:n}=this;return this.bind(),n.viewport(0,0,e,t),this.unbind(),this.width=e,this.height=t,this}bind(){let{context:e,handle:t}=this;return e.bindFramebuffer(e.FRAMEBUFFER,t),this}unbind(){let{context:e}=this;return e.bindFramebuffer(e.FRAMEBUFFER,null),this}blit(e){let{context:t,width:n,height:r}=this;return t.bindFramebuffer(t.READ_FRAMEBUFFER,this.handle),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e.handle),t.blitFramebuffer(0,0,n,r,0,0,e.width,e.height,t.COLOR_BUFFER_BIT,t.LINEAR),t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),this}delete(){let{context:e,handle:t}=this;t!==null&&(e.deleteFramebuffer(t),this.handle=null)}},de=class{constructor(e,t,n){let r=e.createShader(t);if(e.shaderSource(r,n),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS))throw new Error("Can't compile shader: "+e.getShaderInfoLog(r));this.context=e,this.handle=r}delete(){let{context:e,handle:t}=this;t!==null&&(e.deleteShader(t),this.handle=null)}},H=class{constructor(e,t,n){let r=new de(e,e.VERTEX_SHADER,t),i=new de(e,e.FRAGMENT_SHADER,n),s=e.createProgram();if(e.attachShader(s,r.handle),e.attachShader(s,i.handle),e.linkProgram(s),!e.getProgramParameter(s,e.LINK_STATUS))throw new Error("Can't link shader program: "+e.getProgramInfoLog(s));r.delete(),i.delete(),this.context=e,this.handle=s,this.uniformLocationCache={}}bind(){let{context:e,handle:t}=this;return e.useProgram(t),this}getUniformLocation(e){let{context:t,handle:n,uniformLocationCache:r}=this;return e in r?r[e]:r[e]=t.getUniformLocation(n,e)}setUniform(e,t){let{context:n}=this;this.bind();let r=this.getUniformLocation(e);return typeof t=="boolean"?n.uniform1i(r,t?1:0):n.uniform1f(r,t),this}setUniformInteger(e,t){let{context:n}=this;this.bind();let r=this.getUniformLocation(e);return n.uniform1i(r,t),this}setUniformMatrix(e,t,n=!1){let{context:r}=this;this.bind();let i=this.getUniformLocation(e);return r.uniformMatrix4fv(i,n,t),this}delete(){let{context:e,handle:t}=this;t!==null&&(e.deleteProgram(t),this.handle=null)}},k=class{constructor(e,t,n,r,i=e.RGBA8){let s=e.createTexture();e.activeTexture(e.TEXTURE0),e.bindTexture(t,s),e.texImage2D(t,0,i,n,r,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(t,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(t,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(t,e.TEXTURE_WRAP_R,e.CLAMP_TO_EDGE),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.LINEAR),this.context=e,this.handle=s,this.type=t}bind(e=0){let{context:t,handle:n,type:r}=this;return t.activeTexture(e+t.TEXTURE0),t.bindTexture(r,n),this}setImage(e){let{context:t,type:n}=this;return this.bind(),t.texSubImage2D(n,0,0,0,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(n,t.TEXTURE_MIN_FILTER,t.LINEAR_MIPMAP_LINEAR),t.generateMipmap(n),this}delete(){let{context:e,handle:t}=this;t!==null&&(e.deleteTexture(t),this.handle=null)}},Re=class{constructor(e,t,n,r=e.STATIC_DRAW){let i=e.createBuffer();e.bindBuffer(t,i),e.bufferData(t,n,r),this.context=e,this.handle=i,this.type=t,this.usage=r}bind(){let{context:e,handle:t,type:n}=this;return e.bindBuffer(n,t),this}setData(e){let{context:t,type:n}=this;return this.bind(),t.bufferData(n,e,this.usage),this}setDataRange(e,t,n){let{context:r,type:i}=this;return this.bind(),r.bufferSubData(i,t,e,0,n),this}delete(){let{context:e,handle:t}=this;t!==null&&(e.deleteBuffer(t),this.handle=null)}},ee=class{constructor(e,t,n,r,i){this.elements=e,this.type=t,this.normalized=n,this.stride=r,this.offset=i}},Se=class{constructor(e,t,n){let r=e.createVertexArray();e.bindVertexArray(r),t.bind();for(let i=0;i<n.length;i++){e.enableVertexAttribArray(i);let s=n[i];e.vertexAttribPointer(i,s.elements,s.type,s.normalized,s.stride,s.offset)}e.bindVertexArray(null),this.context=e,this.handle=r}bind(){let{context:e,handle:t}=this;return e.bindVertexArray(t),this}unnbind(){let{context:e}=this;return e.bindVertexArray(null),this}draw(e){let{context:t}=this;return this.bind(),t.drawArrays(t.TRIANGLES,0,e),this.unnbind(),this}delete(){let{context:e,handle:t}=this;t!==null&&(e.deleteVertexArray(t),this.handle=null)}},Ee=class{constructor(e,t,n,r=e.STATIC_DRAW){let i=0;for(let u of n)i+=u.elements;let s=new Re(e,e.ARRAY_BUFFER,new Float32Array(i*t),r),l=new Se(e,s,n);this.context=e,this.vertexCount=t,this.vertexArray=l,this.vertexBuffer=s}setData(e){return this.vertexBuffer.setData(e),this}setDataRange(e,t,n){return this.vertexBuffer.setDataRange(e,t,n),this}draw(e=null){return this.vertexArray.draw(e||this.vertexCount),this}delete(){this.vertexArray.delete(),this.vertexBuffer.delete()}},ue=class{constructor(){this.glyphs={}}deserializeDataFromCSV(e,t,n){let r=e.split(`
`);for(let i of r){let s=i.split(",");if(s.length!==10)continue;let l=Number(s[0]),u=Number(s[1]),h=Number(s[2]),d=1-Number(s[3]),m=Number(s[4]),g=1-Number(s[5]),p=Number(s[6])/t,w=1-Number(s[7])/n,c=Number(s[8])/t,b=1-Number(s[9])/n;this.glyphs[l]={charCode:l,advance:u,planeLeft:h,planeBottom:d,planeRight:m,planeTop:g,atlasLeft:p,atlasBottom:w,atlasRight:c,atlasTop:b}}return this}deserializeData(e){let t=new Float32Array(e),n=0,r=t[n++];for(let i=0;i<r;i++){let s=t[n++],l=t[n++],u=t[n++],h=t[n++],d=t[n++],m=t[n++],g=t[n++],p=t[n++],w=t[n++],c=t[n++];this.glyphs[s]={charCode:s,advance:l,planeLeft:u,planeBottom:h,planeRight:d,planeTop:m,atlasLeft:g,atlasBottom:p,atlasRight:w,atlasTop:c}}return this}serializeData(){let e=Object.values(this.glyphs),t=[e.length];for(let n of e){let{charCode:r,advance:i,planeLeft:s,planeBottom:l,planeRight:u,planeTop:h,atlasLeft:d,atlasBottom:m,atlasRight:g,atlasTop:p}=n;t.push(r,i,s,l,u,h,d,m,g,p)}return new Float32Array(t)}},fe=class{constructor(e,t,n){J(this,"MAX_VERTICES",65535);J(this,"VERTEX_ELEMENTS",8);this.context=e,this.vertices=new Float32Array(this.VERTEX_ELEMENTS*this.MAX_VERTICES),this.mesh=new Ee(e,this.MAX_VERTICES,[new ee(2,e.FLOAT,!1,8*4,0),new ee(2,e.FLOAT,!1,8*4,2*4),new ee(4,e.FLOAT,!1,8*4,4*4)],e.DYNAMIC_DRAW),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this.resize(t,n)}resize(e,t){return this.width=e,this.height=t,this.matrix=this.createOrthographicOffCenter(0,e,t,0,-1,1),this}createOrthographicOffCenter(e,t,n,r,i,s){let l=1/(e-t),u=1/(n-r),h=1/(i-s),d=-2*l,m=-2*u,g=2*h,p=(e+t)*l,w=(r+n)*u,c=(s+i)*h;return[d,0,0,0,0,m,0,0,0,0,g,0,p,w,c,1]}clear(e,t,n,r){let{context:i}=this;return i.clearColor(e,t,n,r),i.clear(i.COLOR_BUFFER_BIT),this}beginGeometry(){return this.vertexCount=0,this}endGeometry(){let{VERTEX_ELEMENTS:e,vertexCount:t,vertices:n}=this;if(t!==0)return this.mesh.setDataRange(n,0,e*t),this.mesh.draw(t),this}addVertex(e,t,n,r,i,s,l,u){let{VERTEX_ELEMENTS:h,vertexCount:d,vertices:m}=this;for(let g=0;g<h;g++)m[h*d+g]=arguments[g];return this.vertexCount++,this}drawTriangle(e,t,n,r,i,s,l,u,h,d,m,g,p,w,c,b){let{MAX_VERTICES:y,vertexCount:A}=this;return A+3>=y&&this.endGeometry().beginGeometry(),this.addVertex(e,t,n,r,p,w,c,b).addVertex(i,s,l,u,p,w,c,b).addVertex(h,d,m,g,p,w,c,b)}drawQuad(e,t,n,r,i,s,l,u,h,d,m,g,p,w,c,b,y,A,B,U){return this.drawTriangle(e,t,n,r,i,s,l,u,h,d,m,g,y,A,B,U).drawTriangle(e,t,n,r,h,d,m,g,p,w,c,b,y,A,B,U)}drawRectangle(e,t,n,r,i,s,l,u,h,d,m,g){let p=e,w=t,c=e+n,b=t,y=e+n,A=t+r,B=e,U=t+r;return this.drawQuad(p,w,i,s,c,b,l,s,y,A,l,u,B,U,i,u,h,d,m,g)}drawRectangleOffCenter(e,t,n,r,i,s,l,u,h,d,m,g){let p=n/2,w=r/2,c=e-p,b=t-w,y=e+p,A=t-w,B=e+p,U=t+w,Z=e-p,le=t+w;return this.drawQuad(c,b,i,s,y,A,l,s,B,U,l,u,Z,le,i,u,h,d,m,g)}drawRotatedRectangleOffCenter(e,t,n,r,i,s,l,u,h,d,m,g,p){let w=n/2,c=r/2,b=Math.sin(i),y=Math.cos(i),A=-w,B=-c,U=w,Z=-c,le=w,Ue=c,Ge=-w,Xe=c,et=e+y*A-b*B,tt=t+b*A+y*B,nt=e+y*U-b*Z,rt=t+b*U+y*Z,it=e+y*le-b*Ue,st=t+b*le+y*Ue,ot=e+y*Ge-b*Xe,at=t+b*Ge+y*Xe;return this.drawQuad(et,tt,s,l,nt,rt,u,l,it,st,u,h,ot,at,s,h,d,m,g,p)}drawChar(e,t,n,r,i,s,l,u,h){let d=e.glyphs[r];return typeof d>"u"||d===null?this:this.drawRectangle(t+i*d.planeLeft,n+i*d.planeTop,i*(d.planeRight-d.planeLeft),i*(d.planeBottom-d.planeTop),d.atlasLeft,d.atlasTop,d.atlasRight,d.atlasBottom,s,l,u,h)}drawString(e,t,n,r,i,s,l,u,h){let d=0;for(let m=0;m<r.length;m++){let g=r.charCodeAt(m),p=e.glyphs[g];typeof p>"u"||p===null||(this.drawChar(e,t+d,n,g,i,s,l,u,h),d+=i*p.advance)}return this}drawStringOffCenter(e,t,n,r,i,s,l,u,h){let d=this.measureString(e,r,i);return this.drawString(e,t-d/2,n,r,i,s,l,u,h)}measureString(e,t,n){let r=0;for(let i=0;i<t.length;i++){let s=t.charCodeAt(i),l=e.glyphs[s];typeof l>"u"||l===null||(r+=n*l.advance)}return r}delete(){this.mesh.delete()}},ge=class{constructor(e){this.renderer=e,this.buckets=new Map}begin(){return this.buckets.clear(),this}end(){for(let[e,t]of this.buckets.entries()){e.bind(),this.renderer.beginGeometry();for(let{name:n,args:r}of t)this.renderer[n](...r);this.renderer.endGeometry()}return this}addCommand(e,t,n){let r={name:t,args:n};return this.buckets.has(e)?this.buckets.get(e).push(r):this.buckets.set(e,[r]),this}drawTriangle(e,t,n,r,i,s,l,u,h,d,m,g,p,w,c,b,y){return this.addCommand(e,"drawTriangle",[...arguments].slice(1))}drawQuad(e,t,n,r,i,s,l,u,h,d,m,g,p,w,c,b,y,A,B,U,Z){return this.addCommand(e,"drawQuad",[...arguments].slice(1))}drawRectangle(e,t,n,r,i,s,l,u,h,d,m,g,p){return this.addCommand(e,"drawRectangle",[...arguments].slice(1))}drawRectangleOffCenter(e,t,n,r,i,s,l,u,h,d,m,g,p){return this.addCommand(e,"drawRectangleOffCenter",[...arguments].slice(1))}drawRotatedRectangleOffCenter(e,t,n,r,i,s,l,u,h,d,m,g,p,w){return this.addCommand(e,"drawRotatedRectangleOffCenter",[...arguments].slice(1))}drawChar(e,t,n,r,i,s,l,u,h,d){return this.addCommand(e,"drawChar",[...arguments].slice(1))}drawString(e,t,n,r,i,s,l,u,h,d){return this.addCommand(e,"drawString",[...arguments].slice(1))}drawStringOffCenter(e,t,n,r,i,s,l,u,h,d){return this.addCommand(e,"drawStringOffCenter",[...arguments].slice(1))}measureString(e,t,n){return this.renderer.measureString(e,t,n)}};var Ce=class{get objectType(){return"GameObject"}update(e){}draw(){}},_e=class _e extends Ce{get objectType(){return"Ball"}constructor(e,t,n,r,i,s){super(),this.x=e,this.y=t,this.offsetX=0,this.offsetY=0,this.radius=n,this.velocityX=r,this.velocityY=i,this.type=s}update(e){if(super.update(e),!Y)if((x==="idle"||x==="shot")&&(this.x+=this.velocityX*e,this.y+=this.velocityY*e),S!==null&&x==="shot"){let t=S.x-this.x,n=S.y-this.y,r=xe(t,n),[i,s]=ae(t,n);r<30?(this.offsetX=.9*this.offsetX+.1*(-250/(t*t+n*n)*i),this.offsetY=.9*this.offsetY+.1*(-250/(t*t+n*n)*s)):(this.offsetX*=.975,this.offsetY*=.975)}else this.offsetX*=.975,this.offsetY*=.975}draw(){super.draw();let e=_[_e.types[this.type].texture],[t,n]=Q(this.x,this.y),[r,i]=N(2*this.radius,2*this.radius);f.drawRectangleOffCenter(e,t+this.offsetX,n+this.offsetY,r,i,0,0,1,1,1,1,1,1)}};J(_e,"types",[{texture:"ball0",score:1},{texture:"ball1",score:2},{texture:"ball2",score:3},{texture:"ball3",score:4},{texture:"ball4",score:5},{texture:"ball5",score:6},{texture:"ball6",score:7},{texture:"ball7",score:8}]);var D=_e,ve=class extends D{get objectType(){return"Projectile"}constructor(e,t,n,r,i,s,l){super(e,t,n,r,i,s,l),this.angle=0}update(e){super.update(e),!Y&&((this.x-this.radius<-L/2&&this.velocityX<0||this.x+this.radius>L/2&&this.velocityX>0)&&(this.velocityX=-this.velocityX,Me()),x==="shot"&&(this.angle+=e/100))}draw(){let e=_[D.types[this.type].texture],[t,n]=Q(this.x,this.y),[r,i]=N(2*this.radius,2*this.radius);f.drawRotatedRectangleOffCenter(e,t,n,r,i,this.angle,0,0,1,1,1,1,1,1)}},Ae=class extends D{get objectType(){return"Particle"}constructor(e,t,n,r,i,s,l){super(e,t,n,r,i,s,l),this.lifetime=250*Math.random()}update(e){super.update(e),!Y&&(this.x+=this.velocityX*e,this.y+=this.velocityY*e,this.velocityY+=2e-6*e*e,this.lifetime-=e,(this.lifetime<=0||this.y-this.radius>100)&&$(this))}},pe=class extends D{get objectType(){return"FallingBall"}constructor(e,t,n,r,i,s,l){super(e,t,n,r,i,s,l),this.lifetime=5e3}update(e){super.update(e),!Y&&(this.x+=this.velocityX*e,this.y+=this.velocityY*e,this.velocityY+=2e-6*e*e,this.lifetime-=e,(this.lifetime<=0||this.y-this.radius>100)&&$(this))}draw(){let e=_[D.types[this.type].texture],[t,n]=Q(this.x,this.y),[r,i]=N(2*this.radius,2*this.radius),s=this.lifetime/5e3;f.drawRectangleOffCenter(e,t,n,r,i,0,0,1,1,1,1,1,s)}},Oe=class extends D{get objectType(){return"ExplodingBall"}constructor(e,t,n,r,i,s,l){super(e,t,n,r,i,s,l),this.lifetime=200}update(e){super.update(e),!Y&&(this.x+=this.velocityX*e,this.y+=this.velocityY*e,this.radius*=1.05,this.lifetime-=e,(this.lifetime<=0||this.y-this.radius>100)&&$(this))}draw(){let e=_[D.types[this.type].texture],[t,n]=Q(this.x,this.y),[r,i]=N(2*this.radius,2*this.radius),s=this.lifetime/200;f.drawRectangleOffCenter(e,t,n,r,i,0,0,1,1,1,1,1,s)}},ht=`#version 300 es

uniform mat4 matrix;

layout(location = 0) in vec2 position;
layout(location = 1) in vec2 texCoords;
layout(location = 2) in vec4 color;

out vec2 fragTexCoords;
out vec4 fragColor;

void main() {
    gl_Position = matrix * vec4(position, 0, 1);

    fragTexCoords = texCoords;
    fragColor = color;
}
`,dt=`#version 300 es

precision mediump float;

uniform sampler2D colorTexture;

in vec2 fragTexCoords;
in vec4 fragColor;

out vec4 color;

void main() {
    color = fragColor * texture(colorTexture, fragTexCoords);
}
`,ut=`#version 300 es

uniform mat4 matrix;

layout(location = 0) in vec2 position;
layout(location = 1) in vec2 texCoords;
layout(location = 2) in vec4 color;

out vec2 fragTexCoords;
out vec4 fragColor;

void main() {
    gl_Position = matrix * vec4(position, 0.0, 1.0);

    fragTexCoords = texCoords;
    fragColor = color;
}
`,ft=`#version 300 es

precision mediump float;

uniform sampler2D msdfTexture;
uniform float screenPxRange;
uniform float outlineBias;

in vec2 fragTexCoords;
in vec4 fragColor;

out vec4 color;

float median(float r, float g, float b) {
    return max(min(r, g), min(max(r, g), b));
}

void main() {
    vec4 msd = texture(msdfTexture, fragTexCoords);

    float hardDistance = median(msd.r, msd.g, msd.a);
    float softDistance = msd.a;

    float inner = screenPxRange * (hardDistance - 0.5) + 0.5;
    float outer = screenPxRange * (softDistance - 0.5 + outlineBias) + 0.5;

    float innerOpacity = clamp(inner, 0.0, 1.0);
    float outerOpacity = clamp(outer, 0.0, 1.0);

    color = fragColor * innerOpacity + vec4(vec3(0.0), 1.0) * outerOpacity;
}
`,gt=`#version 300 es

layout(location = 0) in vec2 position;
layout(location = 1) in vec2 texCoords;
layout(location = 2) in vec4 color;

out vec2 fragTexCoords;

void main() {
    gl_Position = vec4(position, 0, 1);

    fragTexCoords = texCoords;
}
`,mt=`#version 300 es

precision mediump float;

const float weight[5] = float[] (0.227027, 0.1945946, 0.1216216, 0.054054, 0.016216);

uniform sampler2D colorTexture;
uniform bool horizontal;

in vec2 fragTexCoords;

out vec4 color;

void main() {
    vec2 texelSize = 1.0 / vec2(textureSize(colorTexture, 0));
    vec3 result = texture(colorTexture, fragTexCoords).rgb * weight[0];

    if (horizontal) {
        for (int i = 1; i < 5; i++) {
            result += texture(colorTexture, fragTexCoords + vec2(texelSize.x * float(i), 0.0)).rgb * weight[i];
            result += texture(colorTexture, fragTexCoords - vec2(texelSize.x * float(i), 0.0)).rgb * weight[i];
        }
    } else {
        for (int i = 1; i < 5; i++) {
            result += texture(colorTexture, fragTexCoords + vec2(0.0, texelSize.y * float(i))).rgb * weight[i];
            result += texture(colorTexture, fragTexCoords - vec2(0.0, texelSize.y * float(i))).rgb * weight[i];
        }
    }

    color = vec4(result, 1.0);
}
`,bt=`#version 300 es

layout(location = 0) in vec2 position;
layout(location = 1) in vec2 texCoords;
layout(location = 2) in vec4 color;

out vec2 fragTexCoords;

void main() {
    gl_Position = vec4(position, 0.0, 1.0);

    fragTexCoords = texCoords;
}
`,pt=`#version 300 es

precision mediump float;

uniform sampler2D colorTexture;
uniform sampler2D blurTexture;

uniform float blurBrightness;

in vec2 fragTexCoords;

out vec4 color;

void main() {
    vec3 result = texture(colorTexture, fragTexCoords).rgb + blurBrightness * texture(blurTexture, fragTexCoords).rgb;
    color = vec4(pow(result, vec3(1.0 / 2.2)), 1.0);
}
`,O=null,R=null,Te=null,De=null,He=null,Fe=null,Le=null,_={},T=null,a=null,f=null,j=null,ye=null,ie=null,W=null,P=null,be=[],yt=0,E=[],q=[],S=null,K=0,x="start",C=4,L=45,I=1,z=0,we=0,X=0,M=0,se=!1,Y=!1,wt="puzzlebobble",We=null,te=[{textureName:"background_0",blurTextureName:"background_0_blur"},{textureName:"background_1",blurTextureName:"background_1_blur"},{textureName:"background_2",blurTextureName:"background_2_blur"}],ne=0,Ke=109,F={ru:{newGame:"\u041D\u043E\u0432\u0430\u044F \u0438\u0433\u0440\u0430",continue:"\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C",level:"\u0423\u0440\u043E\u0432\u0435\u043D\u044C",win:"\u041F\u043E\u0431\u0435\u0434\u0430",fail:"\u041F\u043E\u0440\u0430\u0436\u0435\u043D\u0438\u0435",press:"\u041D\u0430\u0436\u043C\u0438\u0442\u0435",toStartGame:"\u0447\u0442\u043E\u0431\u044B \u043D\u0430\u0447\u0430\u0442\u044C \u0438\u0433\u0440\u0443",toContinue:"\u0447\u0442\u043E\u0431\u044B \u043F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C"},en:{newGame:"New Game",continue:"Continue",level:"Level",win:"Win",fail:"Fail",press:"Press",toStartGame:"to start game",toContinue:"to continue"}},v="en";async function _t(o){return(await fetch(o)).arrayBuffer()}function ze(o){return new Promise(e=>{let t=new Image;t.addEventListener("load",()=>e(t)),t.loading="eager",t.src=o})}async function G(o){let t=await(await fetch(o)).arrayBuffer();return P.context.decodeAudioData(t)}function Q(o,e){let t=a.width/2,n=-Ke,r=a.height/100;return[r*o+t,r*e+n]}function oe(o,e){let t=a.width/2,n=-Ke,r=a.height/100;return[(o-t)/r,(e-n)/r]}function N(o,e){let t=a.height/100;return[t*o,t*e]}function Qe(o,e){return o*o+e*e}function xe(o,e){return Math.sqrt(o*o+e*e)}function ae(o,e){let t=xe(o,e);return[o/t,e/t]}function qe(){let o=new Set;for(let e of E)e.objectType==="Ball"&&o.add(e.type);return[...o]}function xt(o,e,t){for(let n of o)if(Qe(e-n.x,t-n.y)<1.25*n.radius*n.radius)return n;return null}function Rt(o,e,t,n,r){let i=null,s=0;for(;i===null&&s<128;)i=xt(o,e,t),e+=n*C/2,t+=r*C/2,(e-C<-L/2||e+C>L/2)&&(n=-n),s++;return i}function $e(){let o=E.filter(r=>r.objectType==="Ball"),e=new Set,t=-5;for(let r=-10;r<10;r++){let[i,s]=ae(r,t),l=Rt(o,0,90,i,s);l!==null&&e.add(l)}let n=[];for(let r of[...e]){let i=Ze(r).length;for(let s=0;s<i;s++)n.push(r)}return n.map(r=>r.type)}function Pe(){let o=$e();if(o.length===0){let e=qe();return e.length===0?0:e[Math.floor(e.length*Math.random())]}return o[Math.floor(o.length*Math.random())]}function Be(){E=E.filter(t=>t!==S);let o=qe(),e=o.length>0&&o.includes(K)?K:Pe();K=Pe(),E.push(S=new ve(0,95,C,0,0,e))}function me(){E=[],q=[];let o=-I;for(let e=o;e<5;e++)for(let t=-2;t<(e%2?2:3);t++){let n=Math.floor(Math.min(I+3,D.types.length)*Math.random()),r=new D(2*C*t+(e%2?C:0),C+2*C*e,C,0,5e-4,n);E.push(r),e===o&&q.push(r)}ne=Math.floor(Math.random()*te.length),K=$e(),Be()}function Ie(){let{clientWidth:o,clientHeight:e}=O;O.width=o,O.height=e,a.resize(o,e),j.resize(o,e).attachRenderbuffer(new he(R,o,e)),ye.resize(o,e).attachTexture(new k(R,R.TEXTURE_2D,o,e)),ie.resize(o,e).attachTexture(new k(R,R.TEXTURE_2D,o,e)),W.resize(o,e).attachTexture(new k(R,R.TEXTURE_2D,o,e))}async function Ye(){if(O=document.getElementById("canvas"),O===null)return console.error("#canvas not found");if(R=O.getContext("webgl2",{antialias:!1}),R===null)return console.error("Can't create webgl context");De=new H(R,ht,dt),He=new H(R,bt,pt),Fe=new H(R,ut,ft),Le=new H(R,gt,mt),a=new fe(R,O.width,O.height),f=new ge(a),j=new V(R,O.clientWidth,O.clientHeight),ye=new V(R,O.clientWidth,O.clientHeight),ie=new V(R,O.clientWidth,O.clientHeight),W=new V(R,O.clientWidth,O.clientHeight),await Promise.all([...["ball0","ball1","ball2","ball3","ball4","ball5","ball6","ball7","background_0","background_0_blur","background_1","background_1_blur","background_2","background_2_blur","rays","white","blue_button00","circle_05"].map(r=>ze(`./assets/${r}.png`).then(i=>_[r]=new k(R,R.TEXTURE_2D,i.width,i.height,R.SRGB8_ALPHA8).setImage(i))),ze("./assets/font.png").then(r=>_.font=new k(R,R.TEXTURE_2D,r.width,r.height,R.RGBA8).setImage(r)),_t("./assets/font.bin").then(r=>T=new ue().deserializeData(r))]),document.addEventListener("visibilitychange",function(){document.hidden?(P?.suspend(),Y=!0):(P?.resume(),Y=!1)}),document.addEventListener("click",r=>{if(P===null&&(P=new ce,P.resume(),Promise.all([G("./assets/impactGlass_light_000.mp3"),G("./assets/impactGlass_light_001.mp3"),G("./assets/impactGlass_light_002.mp3"),G("./assets/impactGlass_light_003.mp3"),G("./assets/impactGlass_light_004.mp3"),G("./assets/impactGlass_medium_000.mp3"),G("./assets/impactGlass_medium_001.mp3"),G("./assets/impactGlass_medium_002.mp3"),G("./assets/impactGlass_medium_003.mp3"),G("./assets/impactGlass_medium_004.mp3")]).then(i=>be=i)),x==="menu"){X=r.clientX,M=r.clientY;let i=32,[s,l]=N(.8*L,0);X>a.width/2-s/2&&X<a.width/2+s/2&&(M>a.height/2-i-72/2&&M<a.height/2-i+72/2?x="idle":M>a.height/2+i*2-72/2&&M<a.height/2+i*2+72/2&&(I=1,z=0,we=0,x="idle",me()))}else x==="start"?x="idle":["win","fail"].includes(x)&&(typeof window.yandexGamesSDK<"u"?(P?.suspend(),Y=!0,window.yandexGamesSDK.adv.showFullscreenAdv({callbacks:{onClose(){me(),P?.resume(),Y=!1,x="start"},onError(i){console.error(i)}}})):(me(),x="start"))}),document.addEventListener("contextmenu",r=>r.preventDefault()),document.addEventListener("pointerdown",r=>{r.preventDefault(),X=r.clientX,M=r.clientY;let[i,s]=oe(X,M);se=r.button===0&&s<90}),document.addEventListener("pointermove",r=>{r.preventDefault(),X=r.clientX,M=r.clientY;let[i,s]=oe(X,M);se=r.buttons===1&&s<90}),document.addEventListener("pointerup",r=>{r.preventDefault(),X=r.clientX,M=r.clientY;let[i,s]=oe(X,M);if(x==="idle"&&r.button===0&&s<90){x="shot";let l=i,u=Math.min(s,95)-100,[h,d]=ae(l,u),m=.05;S.velocityX=h*m,S.velocityY=d*m}else if(x==="idle"&&(r.button===2||r.button===0&&s>=90)){let l=S.type;S.type=K,K=l}se=!1}),Ie(),addEventListener("resize",Ie);let o=navigator.language.slice(0,2);console.log(`Device language: ${o}`),ke(o),requestAnimationFrame(Je);let e=Number(localStorage.getItem("last_difficulty")||0);e>1&&(I=e,x="menu");let t=Number(localStorage.getItem("last_score")||0);t>0&&(z=t,we=t),me(),console.log("Game ready"),await window.yandexGamesSDKPromise,window.yandexGamesSDK.features.LoadingAPI?.ready(),console.log("Yandex Games SDK ready");let n=window.yandexGamesSDK.environment.i18n.lang;console.log(`SDK language: ${n}`),ke(n),window.yandexGamesSDK.getPlayer({scopes:!1}).then(r=>We=r)}function ke(o){Object.keys(F).includes(o)?v=o:["be","kk","uk","uz"].includes(o)?v="ru":v="en",console.log(`Language changed to ${v}`)}function je(o,e=[]){let t=new Set([o]),n=new Set,r=[o];for(;r.length>0;){let i=r.pop(),s=Ne(i).filter(l=>!e.includes(l));for(let l of s)n.has(l)||(t.add(l),r.push(l)),n.add(l)}return[...t]}function Ze(o){let e=new Set([o]),t=new Set,n=[o];for(;n.length>0;){let r=n.pop(),i=Ne(r);for(let s of i)!t.has(s)&&s.type===r.type&&(e.add(s),n.push(s)),t.add(s)}return[...e]}function Ne(o){let e=[];for(let t of E){if(t.objectType!=="Ball"||t===o)continue;xe(o.x-t.x,o.y-t.y)<(t.radius+o.radius)*1.25&&e.push(t)}return e}function Me(){be.length!==0&&P.play(be[yt++%be.length])}var re=new Set;function $(o){re.add(o)}var St=1e3/30;function Je(o){requestAnimationFrame(Je);let e=Math.min(Te!==null?o-Te:0,St);Te=o;for(let t of E)t.update(e);if(x==="idle"){let t=0,n=E.filter(s=>s.objectType==="Ball");for(let s of n)s.y>t&&(t=s.y);let[r,i]=oe(0,0);if(t<i+4*C&&t<50)for(let s of n)s.y+=e/100}if(x==="shot")for(let t of E){if(t.objectType!=="Ball")continue;let n=S.x-t.x,r=S.y-t.y;if(xe(n,r)<(t.radius+S.radius)*.9){let s=t.x,l=t.y;r*r>n*n?(s+=n>0?t.radius:-t.radius,l+=2*t.radius):s+=n>0?2*t.radius:-2*t.radius,Me();let u=new D(s,l,t.radius,t.velocityX,t.velocityY,S.type);E.push(u);let h=new Set(Ze(u));if(h.size>2){for(let c of[...h]){$(c),z+=D.types[c.type].score,E.push(new Oe(c.x,c.y,C,c.velocityX,c.velocityY,c.type));for(let b=0;b<10;b++){let y=2*Math.random()-1,A=2*Math.random()-1;[y,A]=ae(y,A),y*=.025,A*=.025;let B=C*.25;E.push(new Ae(c.x,c.y,B,y,A,c.type))}}let d=0;for(let c of[...h])d+=50+Math.random()*50,setTimeout(Me,d);let m=new Set;for(let c of[...h]){let b=Ne(c).filter(y=>!h.has(y));for(let y of b)m.add(y)}let g=new Set,p=new Set(q.filter(c=>!h.has(c)));for(let c of[...m]){let b=je(c,[...h]);if(b.filter(y=>p.has(y)).length===0)for(let y of b)g.add(y)}if(g.size)for(let c of[...g]){$(c),z+=D.types[c.type].score;let b=(2*Math.random()-1)*.001,y=c.velocityY;E.push(new pe(c.x,c.y,C,b,y,c.type))}let w=new Set;for(let c of q.filter(b=>!h.has(b)).filter(b=>!g.has(b)))je(c,[...h,...g]).length===1&&w.add(c);if(w.size)for(let c of[...w])$(c),z+=D.types[c.type].score,E.push(new pe(c.x,c.y,C,c.velocityX,c.velocityY,c.type))}setTimeout(Be),x="idle";break}}if(S!==null&&(S.y<0||S.y>100)&&(setTimeout(Be),x="idle"),re.size&&(E=E.filter(t=>!re.has(t)),q=q.filter(t=>!re.has(t)),re.clear()),x==="idle"){let t=E.filter(n=>n.objectType==="Ball");for(let n of t)if(n.y+n.radius>90){z=we,x="fail";break}}if(x==="idle"&&E.filter(t=>["Ball","FallingBall","ExplodingBall","Particle"].includes(t.objectType)).length===0&&(I++,we=z,localStorage.setItem("last_difficulty",I),localStorage.setItem("last_score",z),x="win",We!==null&&typeof window.yandexGamesSDK<"u"&&window.yandexGamesSDK.isAvailableMethod("leaderboards.setLeaderboardScore").then(t=>{t&&window.yandexGamesSDK.getLeaderboards().then(n=>n.setLeaderboardScore(wt,z))})),j.bind(),a.clear(Math.pow(.63,2.2),Math.pow(.88,2.2),Math.pow(.98,2.2),1),De.bind().setUniformMatrix("matrix",a.matrix),x==="menu"){{f.begin();let n=_[te[ne].blurTextureName],r=a.height/100,i=a.width/2,s=a.height/2,l=4*L*r,u=2*a.height;f.drawRectangleOffCenter(n,i-l,s,l,u,0,0,1,1,1,1,1,1),f.drawRectangleOffCenter(n,i,s,l,u,0,0,1,1,1,1,1,1),f.drawRectangleOffCenter(n,i+l,s,l,u,0,0,1,1,1,1,1,1);let h=_[te[ne].textureName],[d,m]=N(L,0);f.drawRectangleOffCenter(h,a.width/2,a.height/2,d,a.height,0,0,1,1,1,1,1,1),f.end()}f.begin(),f.drawRectangle(_.white,0,0,a.width,a.height,0,0,1,1,0,0,0,.75),f.drawRotatedRectangleOffCenter(_.rays,a.width/2,a.height/2,a.height*.5,a.height*.5,o/1e4,0,0,1,1,1,1,1,.5),f.end();let t=32;{let[n,r]=N(.8*L,0);f.begin(),f.drawRectangleOffCenter(_.blue_button00,a.width/2,a.height/2-t*1,n,72,0,0,1,1,1,1,1,1),f.drawRectangleOffCenter(_.blue_button00,a.width/2,a.height/2+t*2,n,72,0,0,1,1,1,1,1,1),f.end()}T!==null&&(Fe.bind().setUniformMatrix("matrix",a.matrix).setUniform("screenPxRange",Math.max(2,t*8/40)).setUniform("outlineBias",.25),_.font.bind(),a.beginGeometry(),a.drawStringOffCenter(T,a.width/2,a.height/2-t*2.25,F[v].continue,t,1,1,1,1),a.drawStringOffCenter(T,a.width/2,a.height/2-t*1.25,F[v].level+" "+I,t*.75,1,1,1,1),a.drawStringOffCenter(T,a.width/2,a.height/2+t*1.25,F[v].newGame,t,1,1,1,1),a.endGeometry())}else{f.begin();{let t=_[te[ne].blurTextureName],n=a.height/100,r=a.width/2,i=a.height/2,s=4*L*n,l=2*a.height;f.drawRectangleOffCenter(t,r-s,i,s,l,0,0,1,1,1,1,1,1),f.drawRectangleOffCenter(t,r,i,s,l,0,0,1,1,1,1,1,1),f.drawRectangleOffCenter(t,r+s,i,s,l,0,0,1,1,1,1,1,1);let u=_[te[ne].textureName],[h,d]=N(L,0);f.drawRectangleOffCenter(u,a.width/2,a.height/2,h,a.height,0,0,1,1,1,1,1,1)}for(let t of E)t.draw();{let t=C*.5,[n,r]=Q(-7,95),[i,s]=N(2*t,2*t);f.drawRectangleOffCenter(_[D.types[K].texture],n,r,i,s,0,0,1,1,1,1,1,1)}se&&x==="idle"&&S!==null&&Ve();{let[t,n]=Q(0,90),[r,i]=N(L,.2);f.drawRectangleOffCenter(_.white,t,n,r,i,0,0,1,1,1,1,1,1)}if(["start","win","fail"].includes(x)&&(f.drawRectangle(_.white,0,0,a.width,a.height,0,0,1,1,0,0,0,.75),f.drawRotatedRectangleOffCenter(_.rays,a.width/2,a.height/2,a.height*.5,a.height*.5,o/1e4,0,0,1,1,1,1,1,.5)),f.end(),T!==null){Fe.bind().setUniformMatrix("matrix",a.matrix).setUniform("screenPxRange",Math.max(2,32*8/40)).setUniform("outlineBias",.25);let[i,s]=N(L/2,0),l=z.toString().padStart(6,"0")+" ",u=a.measureString(T,l,32);f.begin(),f.drawString(_.font,T,i+a.width/2-u,s,l,32,1,1,1,1),x==="start"?I===1?(f.drawStringOffCenter(_.font,T,a.width/2,a.height/2-32*1.75,F[v].press,32,1,1,1,1),f.drawStringOffCenter(_.font,T,a.width/2,a.height/2-32*.5,F[v].toStartGame,32,1,1,1,1)):(f.drawStringOffCenter(_.font,T,a.width/2,a.height/2-32*.75,F[v].level+" "+I,32,1,1,1,1),f.drawStringOffCenter(_.font,T,a.width/2,a.height/2+32*2.75,F[v].press,32*.75,1,1,1,1),f.drawStringOffCenter(_.font,T,a.width/2,a.height/2+32*3.75,F[v].toContinue,32*.75,1,1,1,1)):x==="win"?(f.drawStringOffCenter(_.font,T,a.width/2,a.height/2-32*.75,F[v].win,32,1,1,1,1),f.drawStringOffCenter(_.font,T,a.width/2,a.height/2+32*2.75,F[v].press,32*.75,1,1,1,1),f.drawStringOffCenter(_.font,T,a.width/2,a.height/2+32*3.75,F[v].toContinue,32*.75,1,1,1,1)):x==="fail"&&(f.drawStringOffCenter(_.font,T,a.width/2,a.height/2-32*.75,F[v].fail,32,1,1,1,1),f.drawStringOffCenter(_.font,T,a.width/2,a.height/2+32*2.75,F[v].press,32*.75,1,1,1,1),f.drawStringOffCenter(_.font,T,a.width/2,a.height/2+32*3.75,F[v].toContinue,32*.75,1,1,1,1)),f.end()}}j.unbind(),j.blit(ye),j.bind(),a.clear(0,0,0,0),De.bind().setUniformMatrix("matrix",a.matrix),se&&x==="idle"&&S!==null&&(f.begin(),S.draw(),Ve(),f.end()),j.unbind(),j.blit(W);for(let t=0;t<4;t++)Le.bind().setUniform("horizontal",!0),ie.bind(),W.attachment.bind(),a.beginGeometry(),a.drawRectangleOffCenter(0,0,2,2,0,0,1,1,1,1,1,1),a.endGeometry(),ie.unbind(),Le.bind().setUniform("horizontal",!1),W.bind(),ie.attachment.bind(),a.beginGeometry(),a.drawRectangleOffCenter(0,0,2,2,0,0,1,1,1,1,1,1),a.endGeometry(),W.unbind();R.viewport(0,0,a.width,a.height),He.bind().setUniformInteger("blurTexture",1).setUniform("blurBrightness",(Math.sin(8*o/1e3)+1)/2),ye.attachment.bind(),W.attachment.bind(1),a.beginGeometry(),a.drawRectangleOffCenter(0,0,2,2,0,0,1,1,1,1,1,1),a.endGeometry()}function Ve(){let[o,e]=oe(X,M);e=Math.min(e,95);let t=o,n=e-100,[r,i]=ae(t,n),s=S.x,l=S.y,u=E.filter(h=>h.objectType==="Ball");for(let h=1;h<=1e3;h++)if(s+=r/10,l+=i/10,(s-S.radius<-L/2||s+S.radius>L/2)&&(r=-r),h%50===0){for(let c of u)if(Qe(s-c.x,l-c.y)<1.5*C*C)return;let d=C/3,[m,g]=Q(s,l),[p,w]=N(2*d,2*d);f.drawRectangleOffCenter(_.circle_05,m,g,p,w,0,0,1,1,1,1,1,1)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ye):Ye();})();
